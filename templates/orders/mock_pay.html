{% extends 'base.html' %}
{% load static %}

{% block title %}Confirm Payment - Inkingi Wood Ltd{% endblock %}

{% block content %}
<section class="mock-pay-page py-5">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12 col-lg-8">
        <header class="mb-5 text-center">
          <h1 class="display-5 fw-bold mb-2">Complete Payment</h1>
          <p class="lead text-muted">Review and confirm your purchase</p>
        </header>

        <div class="row">
          <!-- Product Summary -->
          <div class="col-lg-5 mb-4 mb-lg-0">
            <div class="card shadow-sm border-0">
              <div class="position-relative overflow-hidden" style="height: 300px;">
                {% if product.image %}
                  <img 
                    src="{{ product.image.url }}" 
                    alt="{{ product.name }}" 
                    class="w-100 h-100 object-fit-cover">
                {% else %}
                  <img 
                    src="{% static 'img/placeholder.png' %}" 
                    alt="No image available" 
                    class="w-100 h-100 object-fit-cover">
                {% endif %}
              </div>
              <div class="card-body">
                <h2 class="card-title h4 fw-bold mb-3">{{ product.name }}</h2>
                
                <div class="mb-3">
                  <p class="mb-2 text-muted">
                    <strong>Price per unit:</strong> {{ product.price }} RWF
                  </p>
                  <p class="mb-2 text-muted">
                    <strong>Available stock:</strong> {{ product.stock }} units
                  </p>
                  {% if product.unit %}
                    <p class="mb-0 text-muted">
                      <strong>Unit:</strong> {{ product.unit }}
                    </p>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <!-- Payment Form -->
          <div class="col-lg-7">
            <div class="card shadow-sm border-0">
              <div class="card-header bg-light p-4 border-0">
                <h5 class="fw-bold mb-0">Enter Quantity</h5>
              </div>
              <div class="card-body p-5">
                <form method="post" novalidate>
                  {% csrf_token %}

                  <div class="mb-4">
                    <label for="quantity" class="form-label fw-bold">Quantity</label>
                    <input 
                      type="number" 
                      name="quantity" 
                      id="quantity"
                      class="form-control form-control-lg" 
                      min="1" 
                      max="{{ product.stock }}"
                      value="1"
                      required
                      aria-label="Quantity to purchase">
                    <small class="form-text text-muted">Maximum: {{ product.stock }} units available</small>
                  </div>

                  <div class="mb-4">
                    <label class="form-label fw-bold">Payment Method</label>
                    <div>
                      {% for code, label in payment_methods %}
                        <div class="form-check form-check-inline">
                          <input class="form-check-input" type="radio" name="payment_method" id="pm_{{ code }}" value="{{ code }}" {% if forloop.first %}checked{% endif %}>
                          <label class="form-check-label" for="pm_{{ code }}">{{ label }}</label>
                        </div>
                      {% endfor %}
                    </div>
                  </div>

                  <div class="mb-4" id="mobileInput" style="display:none;">
                    <label for="mobile_number" class="form-label fw-bold">Mobile Number (for Momo/Airtel)</label>
                    <input type="text" name="mobile_number" id="mobile_number" class="form-control" placeholder="e.g. 250788123456">
                    <small class="form-text text-muted">Optional â€” used only for mock reference.</small>
                  </div>

                  <hr class="my-4">

                  <!-- Price Calculation Preview -->
                  <div class="alert alert-info" role="alert">
                    <p class="mb-2">
                      <strong>Unit Price:</strong> {{ product.price }} RWF
                    </p>
                    <hr class="my-2">
                    <p class="mb-0">
                      <strong>Total Amount:</strong> <span class="h5 text-success fw-bold">
                        <span id="totalAmount">{{ product.price }}</span> RWF
                      </span>
                    </p>
                  </div>

                  <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-success btn-lg fw-bold">
                      Proceed to Payment
                    </button>
                    <a href="{% url 'products:product_detail' product.id %}" class="btn btn-outline-secondary">
                      Cancel
                    </a>
                  </div>
                </form>
              </div>
            </div>

            <!-- Info Box -->
            <div class="alert alert-info mt-4" role="alert">
              <h6 class="alert-heading fw-bold">Mock Payment Notice</h6>
              <p class="mb-0 small">This is a simulation. No real payment will be processed. Click "Proceed to Payment" to complete the mock transaction.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  // Update total amount when quantity changes
  document.getElementById('quantity').addEventListener('change', function() {
    const quantity = parseInt(this.value) || 1;
    const unitPrice = {{ product.price }};
    const total = quantity * unitPrice;
    document.getElementById('totalAmount').textContent = total.toFixed(2);
  });
  // Toggle mobile input when payment method is momo/airtel
  (function(){
    const mobileBox = document.getElementById('mobileInput');
    const radios = document.querySelectorAll('input[name="payment_method"]');
    function updateMobile(){
      const sel = document.querySelector('input[name="payment_method"]:checked');
      if(!sel) return;
      if(sel.value === 'momo' || sel.value === 'airtel'){
        mobileBox.style.display = '';
      } else {
        mobileBox.style.display = 'none';
      }
    }
    radios.forEach(r=>r.addEventListener('change', updateMobile));
    updateMobile();
  })();
</script>
{% endblock %}
