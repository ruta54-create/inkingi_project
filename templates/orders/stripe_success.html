{% extends 'base.html' %}

{% block title %}Payment Success{% endblock %}

{% block content %}
<div class="container my-5">
  <div class="card p-4">
    <h2 class="mb-3">Thank you — payment received</h2>
    <p class="lead">Order #{{ order.id }} is being finalized. This page will update automatically when the payment is processed.</p>
    <div class="d-flex align-items-center mb-3">
      <div id="spinner" class="me-3">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
      <p id="status" class="mb-0" role="status" aria-live="polite">Current status: <strong>{{ order.get_status_display }}</strong></p>
    </div>
    <div id="actions" class="mt-3">
      <a href="{% url 'orders:my_orders' %}" class="btn btn-primary">View My Orders</a>
      <a href="{% url 'products:product_list' %}" class="btn btn-outline-secondary ms-2">Continue Shopping</a>
    </div>
  </div>
</div>

<script>
(function(){
  const orderId = {{ order.id }};
  const statusEl = document.getElementById('status');
  const spinner = document.getElementById('spinner');
  // Create toast container
  let toastContainer = document.getElementById('toast-container');
  if(!toastContainer){
    toastContainer = document.createElement('div');
    toastContainer.id = 'toast-container';
    toastContainer.style.position = 'fixed';
    toastContainer.style.top = '1rem';
    toastContainer.style.right = '1rem';
    toastContainer.style.zIndex = 1080;
    document.body.appendChild(toastContainer);
  }

  function showToast(message, variant='success'){
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${variant} border-0 show`;
    toast.role = 'alert';
    toast.ariaLive = 'assertive';
    toast.ariaAtomic = 'true';
    toast.style.minWidth = '200px';
    toast.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
    toastContainer.appendChild(toast);
    setTimeout(()=>{ try{ toast.remove(); }catch(e){} }, 7000);
  }

  let attempts = 0;
  const maxAttempts = 12; // poll for up to ~1 minute
  function poll(){
    attempts++;
    fetch(`{% url 'orders:stripe_order_status' 0 %}`.replace('/0/','/'+orderId+'/'))
      .then(r=>r.json())
      .then(data=>{
        if(data && data.status){
          statusEl.innerHTML = 'Current status: <strong>' + data.status + '</strong>';
          if(data.status === 'completed'){
            if(spinner) spinner.style.display = 'none';
            showToast('Payment confirmed — order completed', 'success');
            return;
          }
        }
        if(attempts < maxAttempts){
          setTimeout(poll, 5000);
        } else {
          if(spinner) spinner.style.display = 'none';
          showToast('Payment is still being processed. If this persists, contact support.', 'warning');
        }
      }).catch(()=>{ if(attempts < maxAttempts) setTimeout(poll,5000); });
  }
  poll();
})();
</script>
{% endblock %}